<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Home</title>

    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link rel="stylesheet" th:href="@{/css/style.css}"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css"
          integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">

    <!--mapbox-->
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.css' rel='stylesheet' />

    <!-- Turf.js plugin -->
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

</head>
<body>
<!-- NAVBAR -->

<!-- TO-DO:
    Dropdown lista koga kje se namali goleminata na starnata -->
<section id="nav-bar">
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="home.html"><img th:src="@{/images/logo}"></a>
            <button class="navbar-toggler btn-outline-light" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navmenu">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <!--mx-auto ili ova-->
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" th:href="@{/home}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/aboutus}">About-us</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/contact}">Contact us</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/help}">Help</a>
                    </li>
                </ul>
            </div>
            <form class="d-flex">
                <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
                <button class="btn btn-light" type="submit">Search</button>
            </form>
        </div>
    </nav>
</section>

<!-- Selection part -->

<section id="selectpart">
    <div class="container">
        <div class="row align-items-center justify-content-between">
            <div class="col-md-6 ">
                <!--                <p class="ms-4">Are you in school or in university?-->
                <!--                <p>-->
                <!--                <div class="form-check ms-4">-->
                <!--                    <input class="form-check-input" type="radio" name="flexRadioDefault" id="1">-->
                <!--                    <label class="form-check-label" for="1">-->
                <!--                        School-->
                <!--                    </label>-->
                <!--                </div>-->
                <!--                <div class="form-check ms-4">-->
                <!--                    <input class="form-check-input" type="radio" name="flexRadioDefault" id="2" checked>-->
                <!--                    <label class="form-check-label" for="2">-->
                <!--                        University-->
                <!--                    </label>-->
                <!--                </div>-->
            </div>
            <div class="col-md-6">
                <div class="form-outline">
                    <!-- <input type="search" id="form1" class="form-control" placeholder="Type query" aria-label="Search" /> -->
                </div>
                <div class="selectors float-end">

                    <select class="form-select py-3 mt-5 btn-success aria-label=Default select example">
                        <option th:each="school : ${schools}" >
                            <th:block th:text="${school.getName()}" th:value="${school.getName()}"></th:block>
                        </option>
                    </select>

                </div>

            </div>
        </div>
    </div>
</section>

<section>
    <div class="container">
        <div class="sidebar">
            <div class="heading">
                <h4>Our locations</h4>
            </div>
            <div id="listings" class="listings"></div>
        </div>
        <div id="map" class="map" style="width: 700px; height:265px"></div>

    </div>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiYW1taXRyZXZza2EiLCJhIjoiY2t4bms0djlqNW51dDJ3bzU4N3Y3MHNnMyJ9.3JN-PxishDOcsPGrfSx5JA';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [21.4254, 41.9981],
            zoom: 10,
            scrollZoom: true
        });

        const libraries = {
            "type": "FeatureCollection",
            "features": [
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Државен архив на Северна Македонија",
                        "city": "",
                        "street": "",
                        "opening_hours": "",
                        "phone": ""
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            21.4343486,
                            41.9968185
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Германска читалница",
                        "city": "Cкoпje",
                        "street": "Булевар Гоце Делчев",
                        "opening_hours": "Mo  We  Fr 11:00-14:30; Tu  Th 12:00-18:00; Sa[1] 11:00-15:00",
                        "phone": ""
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            21.4393671,
                            41.9981313
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Американско катче Македонија",
                        "city": "Cкoпje",
                        "street": "Булевар Гоце Делчев",
                        "opening_hours": "Mo-Fr 10:00-20:00; Sa 11:00-16:00",
                        "phone": "+389 2 3120020"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            21.4397823,
                            41.9980573
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Библиотека „Браќа Миладиновци“ - Карпош",
                        "city": "Cкoпje",
                        "street": "Иван Аговски",
                        "opening_hours": "",
                        "phone": ""
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            21.4120526,
                            42.0027424
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Илјада книги",
                        "city": "Скопје",
                        "street": "",
                        "opening_hours": "",
                        "phone": ""
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            21.4354639,
                            41.9946963
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Другарче",
                        "city": "",
                        "street": "",
                        "opening_hours": "",
                        "phone": ""
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            21.4004515,
                            42.0036192
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Архив на град Скопје",
                        "city": "",
                        "street": "Московска",
                        "opening_hours": "",
                        "phone": ""
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            21.3907447,
                            42.0030932
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Национална и универзитетска библиотека",
                        "city": "Cкoпje",
                        "street": "Булевар Гоце Делчев",
                        "opening_hours": "",
                        "phone": ""
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            21.439345,
                            41.9979496
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Гралска библиотека браќа миладиновци Скопје",
                        "city": "Cкoпje",
                        "street": "Булевар Партизански Одреди",
                        "opening_hours": "",
                        "phone": "+389 2 3162 544"
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            21.4201783,
                            41.9997606
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Библиотека „Браќа Миладиновци“",
                        "city": "",
                        "street": "",
                        "opening_hours": "",
                        "phone": ""
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            21.4202483,
                            41.9997022
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Браќа Миладиновци",
                        "city": "",
                        "street": "Виа Игнација",
                        "opening_hours": "",
                        "phone": ""
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            21.3614728,
                            42.0064775
                        ]
                    }
                },
                {
                    "type": "Feature",
                    "properties": {
                        "name": "Факултетска библиотека и компјутерница",
                        "city": "",
                        "street": "",
                        "opening_hours": "",
                        "phone": ""
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [
                            21.4587078,
                            42.0029542
                        ]
                    }
                }
            ]
        };

        libraries.features.forEach(function (store, i) {
            store.properties.id = i;
        });

        map.on('load', () => {
            map.addLayer({
                id: 'locations',
                type: 'circle',
                /* Add a GeoJSON source containing place coordinates and information. */
                source: {
                    type: 'geojson',
                    data: libraries
                }
            });
            buildLocationList(libraries);
        });

        map.on('click', (event) => {
            /* Determine if a feature in the "locations" layer exists at that point. */
            const features = map.queryRenderedFeatures(event.point, {
                layers: ['locations']
            });

            /* If it does not exist, return */
            if (!features.length) return;

            const clickedPoint = features[0];

            /* Fly to the point */
            flyToStore(clickedPoint);

            /* Close all other popups and display popup for clicked store */
            createPopUp(clickedPoint);

            /* Highlight listing in sidebar (and remove highlight for all other listings) */
            const activeItem = document.getElementsByClassName('active');
            event.stopPropagation();
            if (activeItem[0]) {
                activeItem[0].classList.remove('active');
            }
            const listing = document.getElementById(
                `listing-${clickedPoint.properties.id}`
            );
            listing.classList.add('active');
        });

        function buildLocationList(libraries) {
            for (const store of libraries.features) {
                /* Add a new listing section to the sidebar. */
                const listings = document.getElementById('listings');
                const listing = listings.appendChild(document.createElement('div'));

                /* Assign a unique `id` to the listing. */
                listing.id = `listing-${store.properties.id}`;

                /* Assign the `item` class to each listing for styling. */
                listing.className = 'item';

                /* Add the link to the individual listing created above. */
                const link = listing.appendChild(document.createElement('a'));
                link.href = '#';
                link.className = 'title';
                link.id = `link-${store.properties.id}`;
                link.innerHTML = `${store.properties.name}`;

                /* Add details to the individual listing. */
                const details = listing.appendChild(document.createElement('div'));
                details.innerHTML = `${store.properties.city}`;
                details.innerHTML = `${store.properties.street}`;
                if (store.properties.phone) {
                    details.innerHTML += ` <br> ${store.properties.phone}`;
                }
                if (store.properties.opening_hours) {
                    details.innerHTML += ` <br> ${store.properties.opening_hours}`;
                }
                if (store.properties.distance) {
                    const roundedDistance = Math.round(store.properties.distance * 100) / 100;
                    details.innerHTML += `<div><strong>${roundedDistance} kilometers away</strong></div>`;
                }

                link.addEventListener('click', function () {
                    for (const feature of libraries.features) {
                        if (this.id === `link-${feature.properties.id}`) {
                            flyToStore(feature);
                            createPopUp(feature);
                        }
                    }
                    const activeItem = document.getElementsByClassName('active');
                    if (activeItem[0]) {
                        activeItem[0].classList.remove('active');
                    }
                    this.parentNode.classList.add('active');
                });
            }
        }

        function flyToStore(currentFeature) {
            map.flyTo({
                center: currentFeature.geometry.coordinates,
                zoom: 15
            });
        }

        function createPopUp(currentFeature) {
            const popUps = document.getElementsByClassName('mapboxgl-popup');
            /** Check if there is already a popup on the map and if so, remove it */
            if (popUps[0]) popUps[0].remove();

            const popup = new mapboxgl.Popup({ closeOnClick: false })
                .setLngLat(currentFeature.geometry.coordinates)
                .setHTML(`<h5>${currentFeature.properties.name}</h5>`)
                .addTo(map);
        }
    </script>
</section>

<section id="footer" class="fixed-bottom">
    <div class="container">
        <div class="row">
            <div class="col-md-4 footer-box text-center">
                <p><b>ABOUT US</b></p>
                <p>This web application is meant to find the nearest libraries to a specific school or university.
                    We remembered our need to know where we could get needed literature or to simply know a nearby quiet
                    library where we could
                    study more effectively, for that purpose, we decided to make it easier for the other students.</p>
            </div>
            <div class="col-md-4 footer-box text-center">
                <p><b>CONTACT US</b></p>
                <p><i class="fas fa-phone"></i> +398 78 000 000</p>
                <p><i class="fas fa-envelope"></i> xyz@gamil.com</p>
            </div>
            <div class="col-md-4 footer-box text-center">
                <h5 class="text-uppercase">Links</h5>
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" th:href="@{/home}">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/aboutus}">About-us</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/contact}">Contact us</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/help}">Help</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</section>
</body>
</html>